---
import Layout from '../layouts/Layout.astro';
import libraryData from '../data/library.json';

// Filter out hidden resources
const resources = libraryData.resources.filter(r => !r.hidden);

// Extract unique values for filters
const allTopics = [...new Set(resources.flatMap(r => r.topics))].sort();
const allTeachers = [...new Set(resources.map(r => r.teacher))].sort();
const allLanguages = [...new Set(resources.map(r => r.language))].sort();
const allSourceTypes = [...new Set(resources.map(r => r.sourceType))].sort();
---

<Layout title="Dhamma Finder - Kalyanamitta">
  <div class="finder-container">
    <!-- Main Content -->
    <div class="finder-content">
      <!-- Disclaimer -->
      <div class="disclaimer">
        <p class="disclaimer-eng">
          Portal to external sites. Use wisdom (<em>Yonisomanasikāra</em>) when exploring.
        </p>
        <p class="disclaimer-sin" style="display: none;">
          බාහිර අඩවි වෙත දොරටුවකි. ප්‍රඥාව (<em>යෝනිසෝමනසිකාරය</em>) භාවිතා කරන්න.
        </p>
      </div>

      <!-- Search Section -->
      <div class="search-section">
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="Search resources..."
          autocomplete="off"
        />

        <div class="filters-row">
          <select id="topicFilter" class="compact-select">
            <option value="">All Topics</option>
            {allTopics.map(topic => (
              <option value={topic}>{topic}</option>
            ))}
          </select>

          <select id="teacherFilter" class="compact-select">
            <option value="">All Teachers</option>
            {allTeachers.map(teacher => (
              <option value={teacher}>{teacher}</option>
            ))}
          </select>

          <select id="languageFilter" class="compact-select">
            <option value="">All Languages</option>
            <option value="English">English</option>
            <option value="Sinhala">Sinhala</option>
            <option value="Multilingual">Multilingual</option>
          </select>

          <select id="sourceFilter" class="compact-select">
            <option value="">All Sources</option>
            {allSourceTypes.map(type => (
              <option value={type}>{type.charAt(0).toUpperCase() + type.slice(1)}</option>
            ))}
          </select>

          <button class="reset-btn" id="resetFilters" title="Reset filters">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
            <span class="reset-text">Reset</span>
          </button>
        </div>

      </div>

      <!-- Resources List -->
      <section class="resources-list" id="resourcesGrid">
        {resources.map(resource => (
          <article class="resource-card" 
            data-id={resource.id}
            data-title={resource.title.toLowerCase()}
            data-description={resource.description.toLowerCase()}
            data-teacher={resource.teacher}
            data-language={resource.language}
            data-source={resource.sourceType}
            data-topics={resource.topics.join(',')}
            data-featured={resource.featured}>
            
            <div class="card-content">
              <!-- Top badges -->
              <div class="card-badges">
                <span class="badge-type" data-source={resource.sourceType}>
                  {resource.sourceType === 'youtube' ? 'YouTube' : 'Website'}
                </span>
                {resource.featured && (
                  <span class="badge-featured">★ Featured</span>
                )}
              </div>

              <!-- Title -->
              <h3 class="card-title">
                <a href={resource.url} target="_blank" rel="noopener noreferrer">
                  {resource.title}
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M7 17L17 7M7 7h10v10"/>
                  </svg>
                </a>
              </h3>

              <!-- Description -->
              <p class="card-description">{resource.description}</p>

              <!-- Meta info -->
              <div class="card-meta">
                <span class="meta-teacher">{resource.teacher}</span>
                <span class="meta-divider">•</span>
                <span class="meta-language">{resource.language}</span>
              </div>

              <!-- Topics -->
              <div class="card-topics">
                {resource.topics.slice(0, 3).map(topic => (
                  <span class="topic">{topic}</span>
                ))}
                {resource.topics.length > 3 && (
                  <span class="topic more">+{resource.topics.length - 3}</span>
                )}
              </div>
            </div>
          </article>
        ))}
      </section>

      <!-- No Results -->
      <div class="no-results" id="noResults" style="display: none;">
        <p>No resources found. Try different filters.</p>
      </div>

      <!-- Loading -->
      <div class="loading-more" id="loadingMore" style="display: none;">
        <div class="spinner"></div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .finder-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
  }

  .finder-content {
    max-width: 1000px;
    margin: 0 auto;
    padding: 1.5rem 1rem 3rem;
  }

  /* Disclaimer */
  .disclaimer {
    background: rgba(255, 255, 255, 0.9);
    border-left: 3px solid #b91c1c;
    border-radius: 6px;
    padding: 0.75rem 1rem;
    margin-bottom: 1.5rem;
  }

  .disclaimer p {
    margin: 0;
    font-size: 0.8125rem;
    color: #4b5563;
    line-height: 1.5;
  }

  .disclaimer em {
    color: #991b1b;
    font-style: italic;
    font-weight: 500;
  }

  .disclaimer-sin {
    font-family: 'Noto Sans Sinhala', sans-serif;
  }

  @media (max-width: 640px) {
    .disclaimer {
      padding: 0.625rem 0.875rem;
    }
    .disclaimer p {
      font-size: 0.75rem;
    }
  }

  /* Search Section */
  .search-section {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }

  .search-input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: white;
    border: 1px solid rgba(185, 28, 28, 0.2);
    border-radius: 8px;
    color: #1f2937;
    font-size: 0.9375rem;
    transition: border-color 0.2s;
    margin-bottom: 0.875rem;
  }

  .search-input:focus {
    outline: none;
    border-color: #b91c1c;
  }

  @media (max-width: 640px) {
    .search-section {
      padding: 0.875rem;
    }
    .search-input {
      font-size: 0.875rem;
      padding: 0.625rem 0.875rem;
    }
  }

  .filters-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.625rem;
  }

  .compact-select {
    padding: 0.625rem 0.75rem;
    background: white;
    border: 1px solid rgba(185, 28, 28, 0.2);
    border-radius: 8px;
    color: #4b5563;
    font-size: 0.875rem;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .compact-select:focus {
    outline: none;
    border-color: #b91c1c;
  }

  .reset-btn {
    background: rgba(185, 28, 28, 0.1);
    border: 1px solid rgba(185, 28, 28, 0.2);
    border-radius: 8px;
    padding: 0.625rem 0.875rem;
    cursor: pointer;
    color: #b91c1c;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    font-weight: 600;
  }

  .reset-btn:hover {
    background: rgba(185, 28, 28, 0.15);
  }

  .reset-text {
    display: none;
  }

  /* Tablet View */
  @media (max-width: 768px) {
    .filters-row {
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }
    .compact-select:nth-child(4) {
      grid-column: 1;
    }
    .reset-btn {
      grid-column: 2;
    }
  }

  /* Mobile View */
  @media (max-width: 640px) {
    .finder-content {
      padding: 1rem 0.75rem 2rem;
    }

    .search-section {
      padding: 0.75rem;
    }

    .filters-row {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .compact-select,
    .reset-btn {
      font-size: 0.875rem;
      padding: 0.625rem 0.75rem;
      width: 100%;
    }

    .reset-btn {
      grid-column: 1;
      margin-top: 0.25rem;
    }

    .reset-text {
      display: inline;
    }
  }

  /* Extra Small Mobile */
  @media (max-width: 360px) {
    .compact-select,
    .reset-btn {
      font-size: 0.8125rem;
      padding: 0.5rem 0.625rem;
    }
  }

  /* Resources List */
  .resources-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* Resource Card */
  .resource-card {
    background: white;
    border: 1px solid rgba(185, 28, 28, 0.15);
    border-radius: 10px;
    transition: border-color 0.2s, box-shadow 0.2s;
    will-change: transform;
  }

  .resource-card:hover {
    border-color: rgba(185, 28, 28, 0.3);
    box-shadow: 0 2px 8px rgba(185, 28, 28, 0.1);
  }

  .card-content {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
  }

  @media (max-width: 640px) {
    .card-content {
      padding: 1rem;
      gap: 0.75rem;
    }
  }

  /* Card Badges */
  .card-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .badge-type {
    background: rgba(185, 28, 28, 0.08);
    color: #991b1b;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .badge-type[data-source="youtube"] {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
  }

  .badge-featured {
    background: linear-gradient(135deg, #f59e0b, #ea580c);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  @media (max-width: 640px) {
    .badge-type,
    .badge-featured {
      font-size: 0.6875rem;
      padding: 0.1875rem 0.625rem;
    }
  }

  /* Card Title */
  .card-title {
    margin: 0;
    line-height: 1;
  }

  .card-title a {
    color: #111827;
    font-size: 1.125rem;
    font-weight: 700;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    line-height: 1.4;
    transition: color 0.2s;
  }

  .card-title a:hover {
    color: #b91c1c;
  }

  .card-title svg {
    opacity: 0.5;
  }

  /* Card Description */
  .card-description {
    color: #4b5563;
    font-size: 0.9375rem;
    line-height: 1.6;
    margin: 0;
  }

  @media (max-width: 640px) {
    .card-title a {
      font-size: 1rem;
    }
    .card-description {
      font-size: 0.875rem;
      line-height: 1.5;
    }
  }

  /* Card Meta */
  .card-meta {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    font-size: 0.875rem;
    color: #6b7280;
  }

  .meta-teacher {
    font-weight: 600;
  }

  .meta-divider {
    color: #d1d5db;
  }

  .meta-language {
    font-weight: 500;
  }

  /* Card Topics */
  .card-topics {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .topic {
    background: rgba(185, 28, 28, 0.08);
    color: #991b1b;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .topic.more {
    background: rgba(142, 5, 15, 0.08);
    color: #8E050F;
  }

  @media (max-width: 640px) {
    .card-meta {
      font-size: 0.8125rem;
      gap: 0.5rem;
    }
    .topic {
      font-size: 0.6875rem;
      padding: 0.3125rem 0.625rem;
    }
  }

  /* No Results */
  .no-results {
    text-align: center;
    padding: 3rem 2rem;
    color: #4b5563;
    background: rgba(255, 255, 255, 0.85);
    border-radius: 10px;
    backdrop-filter: blur(10px);
  }

  .no-results svg {
    color: #9ca3af;
    margin-bottom: 1rem;
  }

  .no-results h3 {
    color: #1f2937;
    font-size: 1.25rem;
    margin: 0 0 0.5rem 0;
  }

  .no-results p {
    color: #6b7280;
    font-size: 0.9375rem;
    margin: 0 0 1rem 0;
  }

  .reset-button {
    padding: 0.625rem 1.25rem;
    background: linear-gradient(135deg, #b91c1c, #991b1b);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .reset-button:hover {
    background: linear-gradient(135deg, #991b1b, #8E050F);
  }

  /* Loading Indicator */
  .loading-more {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
  }

  .spinner {
    width: 40px;
    height: 40px;
    margin: 0 auto 1rem;
    border: 3px solid rgba(185, 28, 28, 0.1);
    border-top-color: #b91c1c;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-more p {
    margin: 0;
    font-size: 0.875rem;
  }


</style>

<script>
  // Wait for DOM to be ready
  function initializeFinder() {
    // Get all resource cards
    const allItems = Array.from(document.querySelectorAll('.resource-card'));
    let filteredItems: Element[] = [];
    let displayedCount = 0;
    const ITEMS_PER_LOAD = 10;
    
    // Get filter elements
    const searchInput = document.getElementById('searchInput') as HTMLInputElement;
    const topicFilter = document.getElementById('topicFilter') as HTMLSelectElement;
    const teacherFilter = document.getElementById('teacherFilter') as HTMLSelectElement;
    const languageFilter = document.getElementById('languageFilter') as HTMLSelectElement;
    const sourceFilter = document.getElementById('sourceFilter') as HTMLSelectElement;
    const resetFiltersBtn = document.getElementById('resetFilters') as HTMLButtonElement;
    const noResults = document.getElementById('noResults') as HTMLElement;
    const resourcesGrid = document.getElementById('resourcesGrid') as HTMLElement;

    // Verify all elements exist
    if (!searchInput || !topicFilter || !teacherFilter || !languageFilter || !sourceFilter || !resetFiltersBtn) {
      console.error('Filter elements not found');
      return;
    }

    // Filter function
    function filterResources() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedTopic = topicFilter.value;
      const selectedTeacher = teacherFilter.value;
      const selectedLanguage = languageFilter.value;
      const selectedSource = sourceFilter.value;

      // Filter items based on criteria
      filteredItems = allItems.filter(item => {
        const title = (item as HTMLElement).dataset.title || '';
        const description = (item as HTMLElement).dataset.description || '';
        const teacher = (item as HTMLElement).dataset.teacher || '';
        const language = (item as HTMLElement).dataset.language || '';
        const source = (item as HTMLElement).dataset.source || '';
        const topics = (item as HTMLElement).dataset.topics?.split(',') || [];

        // Search match
        const searchMatch = !searchTerm || 
          title.includes(searchTerm) || 
          description.includes(searchTerm) ||
          teacher.toLowerCase().includes(searchTerm) ||
          topics.some(topic => topic.toLowerCase().includes(searchTerm));

        // Filter matches
        const topicMatch = !selectedTopic || topics.includes(selectedTopic);
        const teacherMatch = !selectedTeacher || teacher === selectedTeacher;
        const languageMatch = !selectedLanguage || language === selectedLanguage;
        const sourceMatch = !selectedSource || source === selectedSource;

        return searchMatch && topicMatch && teacherMatch && languageMatch && sourceMatch;
      });

      // Reset display
      allItems.forEach(item => (item as HTMLElement).style.display = 'none');
      displayedCount = 0;
      
      // Load initial batch
      loadMoreItems();

      // Show/hide no results
      if (filteredItems.length === 0) {
        resourcesGrid.style.display = 'none';
        noResults.style.display = 'flex';
        noResults.style.flexDirection = 'column';
        noResults.style.alignItems = 'center';
      } else {
        resourcesGrid.style.display = 'flex';
        noResults.style.display = 'none';
      }
    }

    // Load more items function - optimized
    function loadMoreItems() {
      const itemsToLoad = filteredItems.slice(displayedCount, displayedCount + ITEMS_PER_LOAD);
      
      // Batch DOM updates
      const fragment = document.createDocumentFragment();
      itemsToLoad.forEach(item => {
        (item as HTMLElement).style.display = 'flex';
      });
      
      displayedCount += itemsToLoad.length;
      
      // Update loading indicator
      const loadingMore = document.getElementById('loadingMore');
      if (loadingMore) {
        loadingMore.style.display = displayedCount < filteredItems.length ? 'block' : 'none';
      }
    }

    // Intersection Observer - optimized
    let scrollObserver: IntersectionObserver | null = null;

    function setupInfiniteScroll() {
    scrollObserver?.disconnect();

    const loadingMore = document.getElementById('loadingMore');
    if (!loadingMore) return;

    scrollObserver = new IntersectionObserver((entries) => {
      if (entries[0]?.isIntersecting && displayedCount < filteredItems.length) {
        loadMoreItems();
      }
    }, {
      rootMargin: '200px',
      threshold: 0
    });

    if (displayedCount < filteredItems.length) {
      loadingMore.style.display = 'block';
      scrollObserver.observe(loadingMore);
    } else {
      loadingMore.style.display = 'none';
    }
  }

    // Wrap filter function to reinitialize infinite scroll
    const baseFilter = filterResources;
    const wrappedFilter = function() {
      baseFilter();
      requestAnimationFrame(() => {
        setupInfiniteScroll();
      });
    };

    // Event listeners - optimized with debounce for search
    let searchTimeout: ReturnType<typeof setTimeout>;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(wrappedFilter, 200);
    });
    
    topicFilter.addEventListener('change', wrappedFilter);
    teacherFilter.addEventListener('change', wrappedFilter);
    languageFilter.addEventListener('change', wrappedFilter);
    sourceFilter.addEventListener('change', wrappedFilter);

    resetFiltersBtn.addEventListener('click', () => {
      searchInput.value = '';
      topicFilter.value = '';
      teacherFilter.value = '';
      languageFilter.value = '';
      sourceFilter.value = '';
      wrappedFilter();
    });

    // Initialize - trigger initial filter to load first batch
    wrappedFilter();
  }

  // Language switching - optimized
  function updateDisclaimerLanguage() {
    const disclaimerEng = document.querySelector('.disclaimer-eng') as HTMLElement;
    const disclaimerSin = document.querySelector('.disclaimer-sin') as HTMLElement;
    
    if (!disclaimerEng || !disclaimerSin) return;
    
    const currentLang = localStorage.getItem('language') || 'sinhala';
    const isEnglish = currentLang === 'english';
    
    disclaimerEng.style.display = isEnglish ? 'block' : 'none';
    disclaimerSin.style.display = isEnglish ? 'none' : 'block';
  }

  // Initialize everything when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initializeFinder();
      updateDisclaimerLanguage();
    });
  } else {
    // DOM already loaded
    initializeFinder();
    updateDisclaimerLanguage();
  }

  // Listen for language changes
  window.addEventListener('languageChanged', updateDisclaimerLanguage);

  // Check for language changes periodically (fallback for same-tab changes)
  let lastLanguage = localStorage.getItem('language') || 'sinhala';
  setInterval(() => {
    const currentLanguage = localStorage.getItem('language') || 'sinhala';
    if (currentLanguage !== lastLanguage) {
      lastLanguage = currentLanguage;
      updateDisclaimerLanguage();
    }
  }, 300);
</script>
