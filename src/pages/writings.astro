---
import Layout from '../layouts/Layout.astro';

// Import the Master List (The Portal Plan)
import postsData from '../data/posts.json';

// Sort posts by date (newest first) by default
const sortedPosts = [...postsData].sort((a, b) => 
  new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime()
);
---

<Layout>
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <!-- Page Header -->
    <div class="mb-8 md:mb-12 pt-6 md:pt-8">
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-display font-bold text-gray-900 mb-3 md:mb-4">
        Writings
      </h1>
      <p class="text-base sm:text-lg text-gray-600 mb-4">
        Explore our collection of spiritual teachings and insights
      </p>
      <div id="active-filters" class="hidden flex flex-wrap gap-2 mt-4">
        <!-- Active filters will appear here -->
      </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="mb-6 md:mb-8 space-y-3 md:space-y-4">
      <div class="flex flex-col md:flex-row gap-3 md:gap-4">
        <!-- Enhanced Search Bar -->
        <div class="flex-1">
          <div class="relative group">
            <svg class="absolute left-3 md:left-4 top-1/2 -translate-y-1/2 w-4 h-4 md:w-5 md:h-5 text-gray-400 group-focus-within:text-monk-900 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input
              type="text"
              id="search-input"
              placeholder="Search writings..."
              class="w-full pl-10 md:pl-12 pr-10 md:pr-12 py-3 md:py-3.5 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-monk-900 focus:ring-4 focus:ring-monk-100 transition-all shadow-sm hover:border-gray-400 text-sm md:text-base"
            />
            <button 
              id="clear-search"
              class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors hidden"
              aria-label="Clear search"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div id="search-results-count" class="mt-2 text-sm text-gray-600 hidden">
            <!-- Results count will appear here -->
          </div>
        </div>

        <!-- Enhanced Sort Options -->
        <div class="flex gap-2">
          <div class="relative flex-1 md:flex-none">
            <select 
              id="sort-select"
              class="appearance-none w-full md:w-auto pl-3 md:pl-4 pr-8 md:pr-10 py-3 md:py-3.5 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-monk-900 focus:ring-4 focus:ring-monk-100 bg-white cursor-pointer transition-all shadow-sm hover:border-gray-400 font-medium text-sm md:text-base"
            >
              <option value="desc">ðŸ“… Newest</option>
              <option value="asc">ðŸ“… Oldest</option>
            </select>
            <svg class="absolute right-2 md:right-3 top-1/2 -translate-y-1/2 w-4 h-4 md:w-5 md:h-5 text-gray-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>

          <!-- Enhanced Calendar Button -->
          <button 
            id="calendar-toggle"
            type="button"
            class="px-3 md:px-4 py-3 md:py-3.5 border-2 border-gray-300 rounded-xl hover:border-monk-900 hover:bg-monk-50 transition-all flex items-center gap-2 bg-white shadow-sm font-medium group relative z-10 cursor-pointer"
            aria-label="Toggle calendar"
            aria-expanded="false"
          >
            <svg class="w-4 h-4 md:w-5 md:h-5 text-gray-700 group-hover:text-monk-900 transition-colors pointer-events-none" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
            </svg>
            <span class="hidden sm:inline text-gray-700 group-hover:text-monk-900 pointer-events-none text-sm md:text-base">Calendar</span>
          </button>
        </div>
      </div>

      <!-- Enhanced Calendar Picker (Hidden by default) -->
      <div id="calendar-container" class="hidden">
        <div class="bg-white border-2 border-gray-300 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-2xl">
          <div class="flex items-center justify-between mb-4 md:mb-6">
            <button id="prev-month" class="p-1.5 md:p-2 hover:bg-monk-100 rounded-lg md:rounded-xl transition-all hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Previous month">
              <svg class="w-5 h-5 md:w-6 md:h-6 text-monk-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            <h3 id="calendar-month" class="text-base md:text-lg font-bold text-monk-900">November 2025</h3>
            <button id="next-month" class="p-1.5 md:p-2 hover:bg-monk-100 rounded-lg md:rounded-xl transition-all hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Next month">
              <svg class="w-5 h-5 md:w-6 md:h-6 text-monk-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>
          
          <div id="calendar-grid" class="grid grid-cols-7 gap-0.5 md:gap-1">
            <!-- Calendar days will be inserted here -->
          </div>
          
          <div class="mt-4 md:mt-6 pt-3 md:pt-4 border-t border-gray-200">
            <div class="flex flex-wrap items-center justify-center gap-3 md:gap-4 mb-3 text-xs">
              <div class="flex items-center gap-1.5">
                <div class="w-2.5 h-2.5 md:w-3 md:h-3 bg-monk-900 rounded"></div>
                <span class="text-gray-600">Selected</span>
              </div>
              <div class="flex items-center gap-1.5">
                <div class="w-2.5 h-2.5 md:w-3 md:h-3 bg-monk-100 rounded"></div>
                <span class="text-gray-600">Has posts</span>
              </div>
              <div class="flex items-center gap-1.5">
                <div class="w-2.5 h-2.5 md:w-3 md:h-3 bg-gray-100 rounded"></div>
                <span class="text-gray-600">No posts</span>
              </div>
            </div>
            <div class="flex gap-2">
              <button id="clear-date" class="flex-1 px-3 md:px-4 py-2 md:py-2.5 border-2 border-gray-300 rounded-lg md:rounded-xl hover:bg-gray-50 transition-all text-xs md:text-sm font-semibold text-gray-700 hover:border-gray-400">
                Clear
              </button>
              <button id="today-date" class="px-3 md:px-4 py-2 md:py-2.5 bg-monk-900 text-white rounded-lg md:rounded-xl hover:bg-monk-800 transition-all text-xs md:text-sm font-semibold">
                Today
              </button>
            </div>
          </div>
          
          <div id="selected-date-display" class="mt-4 hidden">
            <div class="bg-monk-50 border border-monk-200 rounded-xl p-3 text-center">
              <p class="text-sm text-monk-900 font-medium">Filtering by: <span id="selected-date-text" class="font-bold"></span></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Posts Grid (Portal Plan: Links to External Monthly Sites) -->
    <div id="posts-container" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
      {sortedPosts.map((post) => (
        <a 
          href={post.url}
          target="_blank"
          rel="noopener noreferrer"
          class="post-card group bg-white rounded-xl md:rounded-2xl p-4 md:p-6 border-2 border-gray-200 hover:border-monk-900 transition-all hover:shadow-xl hover:-translate-y-1 duration-300"
          data-title={post.title.toLowerCase()}
          data-description={post.description.toLowerCase()}
          data-date={post.pubDate}
        >
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gradient-to-r from-monk-100 to-monk-50 text-xs font-semibold text-monk-900 shadow-sm">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
                <span class="post-date">
                  {new Date(post.pubDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                  })}
                </span>
              </div>
              <!-- External Link Icon -->
              <svg class="w-4 h-4 text-monk-600 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
            </div>
            
            <h3 class="text-xl font-display font-semibold text-gray-900 group-hover:text-monk-900 transition-colors">
              {post.title}
            </h3>
            
            <p class="text-gray-600 text-sm line-clamp-3 leading-relaxed">
              {post.description}
            </p>
            
            <div class="flex items-center gap-2 text-monk-900 font-medium pt-2 group-hover:gap-3 transition-all">
              <span class="text-sm">Read more</span>
              <svg class="w-4 h-4 group-hover:translate-x-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </div>
          </div>
        </a>
      ))}
    </div>

    <!-- Enhanced No Results Message -->
    <div id="no-results" class="hidden text-center py-16">
      <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-monk-100 to-monk-50 rounded-2xl mb-6 shadow-lg">
        <svg class="w-10 h-10 text-monk-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h3 class="text-2xl font-bold text-gray-900 mb-3">No writings found</h3>
      <p class="text-gray-600 mb-6 max-w-md mx-auto">We couldn't find any writings matching your search criteria. Try adjusting your filters or search terms.</p>
      <button 
        id="reset-filters"
        class="px-6 py-3 bg-monk-900 text-white rounded-xl hover:bg-monk-800 transition-all shadow-md hover:shadow-lg font-medium"
      >
        Reset All Filters
      </button>
    </div>
  </div>

  <script define:vars={{ postsData }}>
    let selectedDate = null;
    let currentMonth = new Date();
    let datesWithPosts = postsData.map(p => new Date(p.pubDate).toDateString());

    // Get all post cards and elements
    const postCards = document.querySelectorAll('.post-card');
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search');
    const searchResultsCount = document.getElementById('search-results-count');
    const sortSelect = document.getElementById('sort-select');
    const calendarToggle = document.getElementById('calendar-toggle');
    const calendarContainer = document.getElementById('calendar-container');
    const postsContainer = document.getElementById('posts-container');
    const noResults = document.getElementById('no-results');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const clearDateBtn = document.getElementById('clear-date');
    const todayBtn = document.getElementById('today-date');
    const calendarGrid = document.getElementById('calendar-grid');
    const calendarMonth = document.getElementById('calendar-month');
    const selectedDateDisplay = document.getElementById('selected-date-display');
    const selectedDateText = document.getElementById('selected-date-text');
    const activeFiltersContainer = document.getElementById('active-filters');



    // Update active filters display
    function updateActiveFilters() {
      const filters = [];
      
      if (searchInput.value.trim()) {
        filters.push({
          type: 'search',
          text: `Search: "${searchInput.value.trim()}"`,
          action: () => {
            searchInput.value = '';
            filterAndSortPosts(true);
          }
        });
      }
      
      if (selectedDate) {
        const dateObj = new Date(selectedDate);
        filters.push({
          type: 'date',
          text: `Date: ${dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`,
          action: () => {
            selectedDate = null;
            renderCalendar();
            filterAndSortPosts(true);
          }
        });
      }
      
      if (sortSelect.value === 'asc') {
        filters.push({
          type: 'sort',
          text: 'Sort: Oldest First',
          action: () => {
            sortSelect.value = 'desc';
            filterAndSortPosts(true);
          }
        });
      }
      
      if (filters.length > 0) {
        activeFiltersContainer.innerHTML = filters.map(filter => `
          <span class="inline-flex items-center gap-2 px-3 py-1.5 bg-monk-900 text-white text-sm rounded-lg shadow-sm">
            ${filter.text}
            <button onclick="this.parentElement.dispatchEvent(new CustomEvent('remove-filter', { detail: '${filter.type}' }))" 
                    class="hover:bg-monk-800 rounded p-0.5 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </span>
        `).join('');
        
        // Add event listeners to filter badges
        activeFiltersContainer.querySelectorAll('span').forEach((badge, index) => {
          badge.addEventListener('remove-filter', () => {
            filters[index].action();
            updateActiveFilters();
          });
        });
        
        activeFiltersContainer.classList.remove('hidden');
      } else {
        activeFiltersContainer.classList.add('hidden');
      }
    }

    // Enhanced Filter and sort posts
    function filterAndSortPosts(showAnimation = true) {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const sortOrder = sortSelect.value;
      let visibleCount = 0;

      // Convert NodeList to Array and filter
      const postsArray = Array.from(postCards);
      
      // Filter posts
      const filteredPosts = postsArray.filter(card => {
        const title = card.dataset.title;
        const description = card.dataset.description || '';
        const postDate = new Date(card.dataset.date);
        
        // Enhanced search filter - search in both title and description
        if (searchTerm && !title.includes(searchTerm) && !description.includes(searchTerm)) {
          return false;
        }
        
        // Date filter
        if (selectedDate) {
          const selected = new Date(selectedDate);
          if (postDate.toDateString() !== selected.toDateString()) {
            return false;
          }
        }
        
        return true;
      });

      // Enhanced sort with better date comparison
      filteredPosts.sort((a, b) => {
        const dateA = new Date(a.dataset.date);
        const dateB = new Date(b.dataset.date);
        return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
      });

      // Hide all posts first with animation
      postsArray.forEach((card, index) => {
        if (showAnimation) {
          card.style.opacity = '0';
          card.style.transform = 'translateY(20px)';
        }
        card.style.display = 'none';
      });

      // Show and reorder filtered posts with staggered animation
      filteredPosts.forEach((card, index) => {
        card.style.display = 'block';
        postsContainer.appendChild(card);
        
        if (showAnimation) {
          setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
            card.style.transition = 'all 0.3s ease';
          }, index * 50);
        } else {
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        }
        
        visibleCount++;
      });

      // Update search results count
      if (searchTerm) {
        searchResultsCount.textContent = `Found ${visibleCount} writing${visibleCount !== 1 ? 's' : ''}`;
        searchResultsCount.classList.remove('hidden');
        clearSearchBtn.classList.remove('hidden');
      } else {
        searchResultsCount.classList.add('hidden');
        clearSearchBtn.classList.add('hidden');
      }

      // Show/hide no results message
      if (visibleCount === 0) {
        noResults.classList.remove('hidden');
        postsContainer.classList.add('hidden');
      } else {
        noResults.classList.add('hidden');
        postsContainer.classList.remove('hidden');
      }

      // Update selected date display
      if (selectedDate) {
        const dateObj = new Date(selectedDate);
        selectedDateText.textContent = dateObj.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        selectedDateDisplay.classList.remove('hidden');
      } else {
        selectedDateDisplay.classList.add('hidden');
      }

      // Update active filters display
      updateActiveFilters();
    }

    // Enhanced Calendar functions
    function hasPostsInMonth(year, month) {
      return datesWithPosts.some(dateStr => {
        const date = new Date(dateStr);
        return date.getFullYear() === year && date.getMonth() === month;
      });
    }

    function canNavigateToPreviousMonth() {
      const prevMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1);
      const oldestPost = new Date(Math.min(...postsData.map(p => new Date(p.pubDate))));
      return prevMonth >= new Date(oldestPost.getFullYear(), oldestPost.getMonth(), 1);
    }

    function canNavigateToNextMonth() {
      const nextMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1);
      const newestPost = new Date(Math.max(...postsData.map(p => new Date(p.pubDate))));
      return nextMonth <= new Date(newestPost.getFullYear(), newestPost.getMonth(), 1);
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      
      // Update month display
      calendarMonth.textContent = new Date(year, month).toLocaleDateString('en-US', {
        month: 'long',
        year: 'numeric'
      });

      // Update navigation buttons
      prevMonthBtn.disabled = !canNavigateToPreviousMonth();
      nextMonthBtn.disabled = !canNavigateToNextMonth();

      // Clear calendar grid
      calendarGrid.innerHTML = '';

      // Add day headers with better styling
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const header = document.createElement('div');
        header.className = 'text-center text-xs font-bold text-monk-900 py-3';
        header.textContent = day;
        calendarGrid.appendChild(header);
      });

      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      // Add empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        calendarGrid.appendChild(emptyCell);
      }

      const today = new Date();
      const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

      // Add day cells with enhanced styling
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = new Date(year, month, day).toDateString();
        const hasPost = datesWithPosts.includes(dateStr);
        const isSelected = selectedDate && new Date(selectedDate).toDateString() === dateStr;
        const isToday = isCurrentMonth && today.getDate() === day;

        const dayCell = document.createElement('button');
        
        let cellClasses = 'p-3 text-sm rounded-xl transition-all duration-200 relative ';
        
        if (isSelected) {
          cellClasses += 'bg-monk-900 text-white font-bold shadow-lg scale-110 ring-2 ring-monk-300';
        } else if (hasPost) {
          cellClasses += 'bg-monk-100 text-monk-900 hover:bg-monk-200 font-semibold hover:scale-105 cursor-pointer';
        } else {
          cellClasses += 'text-gray-400 bg-gray-50 cursor-not-allowed opacity-60';
        }

        if (isToday && !isSelected) {
          cellClasses += ' ring-2 ring-monk-400';
        }
        
        dayCell.className = cellClasses;
        dayCell.textContent = day;
        
        // Add indicator dot for posts
        if (hasPost && !isSelected) {
          const dot = document.createElement('div');
          dot.className = 'absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 bg-monk-900 rounded-full';
          dayCell.appendChild(dot);
        }
        
        if (hasPost) {
          dayCell.addEventListener('click', () => {
            selectedDate = new Date(year, month, day).toISOString();
            renderCalendar();
            filterAndSortPosts(true);
          });
          
          // Add tooltip
          dayCell.title = `View posts from ${dateStr}`;
        } else {
          dayCell.disabled = true;
        }

        calendarGrid.appendChild(dayCell);
      }
    }

    // Event listeners with debouncing for search
    let searchTimeout;
    searchInput?.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => filterAndSortPosts(true), 300);
    });

    clearSearchBtn?.addEventListener('click', () => {
      if (searchInput) {
        searchInput.value = '';
        searchInput.focus();
        filterAndSortPosts(true);
      }
    });

    sortSelect?.addEventListener('change', () => filterAndSortPosts(true));

    const toggleCalendar = (e) => {
      e?.preventDefault();
      e?.stopPropagation();
      const isHidden = calendarContainer?.classList.contains('hidden');
      
      if (isHidden) {
        calendarContainer?.classList.remove('hidden');
        calendarToggle?.setAttribute('aria-expanded', 'true');
        renderCalendar();
      } else {
        calendarContainer?.classList.add('hidden');
        calendarToggle?.setAttribute('aria-expanded', 'false');
      }
    };

    calendarToggle?.addEventListener('click', toggleCalendar);

    prevMonthBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (!prevMonthBtn.disabled && canNavigateToPreviousMonth()) {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1);
        renderCalendar();
      }
    });

    nextMonthBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (!nextMonthBtn.disabled && canNavigateToNextMonth()) {
        currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1);
        renderCalendar();
      }
    });

    clearDateBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      selectedDate = null;
      renderCalendar();
      filterAndSortPosts(true);
    });

    todayBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const today = new Date();
      const todayStr = today.toDateString();
      
      if (datesWithPosts.includes(todayStr)) {
        selectedDate = today.toISOString();
        currentMonth = new Date(today.getFullYear(), today.getMonth());
        renderCalendar();
        filterAndSortPosts(true);
      } else {
        currentMonth = new Date(today.getFullYear(), today.getMonth());
        renderCalendar();
      }
    });

    // Close calendar when clicking outside
    const handleOutsideClick = (e) => {
      if (calendarContainer && !calendarContainer.classList.contains('hidden')) {
        if (!calendarContainer.contains(e.target) && !calendarToggle?.contains(e.target)) {
          calendarContainer.classList.add('hidden');
          calendarToggle?.setAttribute('aria-expanded', 'false');
        }
      }
    };
    
    document.addEventListener('click', handleOutsideClick);

    // Reset all filters
    const resetFiltersBtn = document.getElementById('reset-filters');
    if (resetFiltersBtn) {
      resetFiltersBtn.addEventListener('click', () => {
        searchInput.value = '';
        selectedDate = null;
        sortSelect.value = 'desc';
        currentMonth = new Date();
        calendarContainer.classList.add('hidden');
        renderCalendar();
        filterAndSortPosts(true);
      });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Escape to close calendar
      if (e.key === 'Escape' && calendarContainer && !calendarContainer.classList.contains('hidden')) {
        calendarContainer.classList.add('hidden');
        calendarToggle?.setAttribute('aria-expanded', 'false');
        calendarToggle?.focus();
      }
      
      // Ctrl/Cmd + K to focus search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        if (searchInput) {
          searchInput.focus();
        }
      }
    });

    // Initialize
    filterAndSortPosts(false);
    document.addEventListener('astro:page-load', () => filterAndSortPosts(false));
  </script>
</Layout>
